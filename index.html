<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>3D Земля + Погода</title>

<style>
body{
  margin:0;
  overflow:hidden;
  background:#000;
  font-family:sans-serif;
}
#ui{
  position:absolute;
  top:10px;
  left:10px;
  background:rgba(0,0,0,0.7);
  padding:10px;
  border-radius:8px;
  color:#FFA500;
}
input,button{
  background:#111;
  color:#FFA500;
  border:1px solid #FFA500;
  padding:5px;
}
</style>
</head>
<body>

<div id="ui">
  <input id="city" placeholder="Город">
  <button onclick="searchCity()">Погода</button>
  <div id="weather"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js"></script>

<script>
// ===== СЦЕНА =====
const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(
  60,
  window.innerWidth/window.innerHeight,
  0.1,
  1000
);
camera.position.z = 3;

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// ===== СФЕРА =====
const geometry = new THREE.SphereGeometry(1,64,64);

const material = new THREE.MeshBasicMaterial({
  color:0xFFA500
});

const earth = new THREE.Mesh(geometry,material);
scene.add(earth);

// ===== ТЕКСТУРА =====
const loader = new THREE.TextureLoader();

loader.load(
"https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg",
(texture)=>{
  earth.material = new THREE.MeshBasicMaterial({
    map:texture
  });
},
undefined,
()=>{
  console.log("Текстура не загрузилась — оставлен оранжевый шар");
}
);

// ===== ВРАЩЕНИЕ =====
function animate(){
  requestAnimationFrame(animate);
  earth.rotation.y += 0.002;
  renderer.render(scene,camera);
}
animate();

// ===== МАРКЕР =====
function addMarker(lat,lon){

  const phi = (90-lat)*(Math.PI/180);
  const theta = (lon+180)*(Math.PI/180);

  const x = -Math.sin(phi)*Math.cos(theta);
  const y = Math.cos(phi);
  const z = Math.sin(phi)*Math.sin(theta);

  const geo = new THREE.SphereGeometry(0.02,16,16);
  const mat = new THREE.MeshBasicMaterial({color:0xff0000});
  const marker = new THREE.Mesh(geo,mat);

  marker.position.set(x,y,z);
  earth.add(marker);
}

// ===== ОЗВУЧКА =====
function speak(text){

  const synth = window.speechSynthesis;
  const utter = new SpeechSynthesisUtterance(text);

  utter.lang = "ru-RU";
  utter.rate = 1;
  utter.pitch = 1;

  synth.cancel(); // остановить старую речь
  synth.speak(utter);
}

// ===== ПОГОДА =====
async function searchCity(){

  const city = document.getElementById("city").value;
  if(!city) return;

  const geo = await fetch(
   `https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1`
  ).then(r=>r.json());

  if(!geo.results){
    weather.innerText="Город не найден";
    speak("Город не найден");
    return;
  }

  const lat = geo.results[0].latitude;
  const lon = geo.results[0].longitude;

  addMarker(lat,lon);

  const wdata = await fetch(
   `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`
  ).then(r=>r.json());

  const w = wdata.current_weather;

  const text =
`${city}.
Температура ${w.temperature} градусов.
Скорость ветра ${w.windspeed} километров в час.`;

  weather.innerText =
`${city}
Температура: ${w.temperature}°C
Ветер: ${w.windspeed} км/ч`;

  // ОЗВУЧКА
  speak(text);
}

// ===== RESIZE =====
window.addEventListener("resize",()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
