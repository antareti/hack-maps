<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>3D Земля PRO + Самолёты</title>

<style>
body{
  margin:0;
  overflow:hidden;
  background:#000;
  font-family:sans-serif;
}
#ui{
  position:absolute;
  top:10px;
  left:10px;
  background:rgba(0,0,0,0.7);
  padding:10px;
  border-radius:8px;
  color:#FFA500;
}
input,button{
  background:#111;
  color:#FFA500;
  border:1px solid #FFA500;
  padding:5px;
  margin:2px;
}
</style>
</head>
<body>

<div id="ui">

<input id="city" placeholder="Город">
<button onclick="searchCity()">Погода</button>

<div id="weather"></div>
<hr>
Клик по Земле → погода<br>
✈️ Самолёты обновляются каждые 15 сек

</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js"></script>

<script>
// ===== СЦЕНА =====
const scene=new THREE.Scene();

const camera=new THREE.PerspectiveCamera(
60,window.innerWidth/window.innerHeight,0.1,1000
);
camera.position.z=3;

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth,window.innerHeight);
renderer.shadowMap.enabled=true;
document.body.appendChild(renderer.domElement);

// ===== СОЛНЦЕ =====
const sun=new THREE.DirectionalLight(0xffffff,1.5);
sun.position.set(5,0,5);
scene.add(sun);

// ===== ЗЕМЛЯ =====
const geometry=new THREE.SphereGeometry(1,64,64);

const earthTexture=new THREE.TextureLoader().load(
"https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg"
);

const earthMaterial=new THREE.MeshPhongMaterial({
map:earthTexture
});

const earth=new THREE.Mesh(geometry,earthMaterial);
scene.add(earth);

// ===== НОЧЬ =====
const nightTexture=new THREE.TextureLoader().load(
"https://threejs.org/examples/textures/planets/earth_lights_2048.png"
);

const night=new THREE.Mesh(
geometry,
new THREE.MeshBasicMaterial({
map:nightTexture,
transparent:true,
opacity:0.6,
blending:THREE.AdditiveBlending
})
);
scene.add(night);

// ===== ОБЛАКА =====
const cloudTexture=new THREE.TextureLoader().load(
"https://threejs.org/examples/textures/planets/earth_clouds_1024.png"
);

const clouds=new THREE.Mesh(
new THREE.SphereGeometry(1.01,64,64),
new THREE.MeshLambertMaterial({
map:cloudTexture,
transparent:true,
opacity:0.4
})
);
scene.add(clouds);

// ===== МАРКЕР =====
function addMarker(lat,lon,color=0xff0000){

const phi=(90-lat)*(Math.PI/180);
const theta=(lon+180)*(Math.PI/180);

const x=-Math.sin(phi)*Math.cos(theta);
const y=Math.cos(phi);
const z=Math.sin(phi)*Math.sin(theta);

const marker=new THREE.Mesh(
new THREE.SphereGeometry(0.02,16,16),
new THREE.MeshBasicMaterial({color})
);

marker.position.set(x,y,z);
earth.add(marker);
}

// ===== ОЗВУЧКА =====
function speak(text){
const u=new SpeechSynthesisUtterance(text);
u.lang="ru-RU";
speechSynthesis.cancel();
speechSynthesis.speak(u);
}

// ===== ПОГОДА ГОРОДА =====
async function searchCity(){

const city=cityInput.value;
if(!city) return;

const geo=await fetch(
`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1`
).then(r=>r.json());

if(!geo.results){
weather.innerText="Город не найден";
speak("Город не найден");
return;
}

const {latitude,longitude}=geo.results[0];

addMarker(latitude,longitude);

getWeather(latitude,longitude,city);
}

// ===== ПОГОДА КООРД =====
async function getWeather(lat,lon,city="Точка"){

const data=await fetch(
`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`
).then(r=>r.json());

const w=data.current_weather;

weather.innerText=
`${city}
Температура: ${w.temperature}°C
Ветер: ${w.windspeed} км/ч`;

speak(
`${city}. Температура ${w.temperature} градусов.
Ветер ${w.windspeed} километров в час.`
);
}

// ===== КЛИК ПО ШАРУ =====
const raycaster=new THREE.Raycaster();
const mouse=new THREE.Vector2();

window.addEventListener("click",(e)=>{

mouse.x=(e.clientX/window.innerWidth)*2-1;
mouse.y=-(e.clientY/window.innerHeight)*2+1;

raycaster.setFromCamera(mouse,camera);
const hit=raycaster.intersectObject(earth);

if(!hit.length) return;

const p=hit[0].point;

const lat=90-(Math.acos(p.y)*180/Math.PI);
const lon=((Math.atan2(p.z,p.x)*180/Math.PI)+180)%360-180;

addMarker(lat,lon,0x00ff00);

getWeather(lat,lon,"Точка клика");
});

// ===== САМОЛЁТЫ =====
let planes=[];

async function loadPlanes(){

// очистка старых
planes.forEach(p=>earth.remove(p));
planes=[];

const data=await fetch(
"https://opensky-network.org/api/states/all"
).then(r=>r.json());

if(!data.states) return;

data.states.slice(0,200).forEach(s=>{

const lat=s[6];
const lon=s[5];

if(!lat||!lon) return;

const phi=(90-lat)*(Math.PI/180);
const theta=(lon+180)*(Math.PI/180);

const x=-Math.sin(phi)*Math.cos(theta);
const y=Math.cos(phi);
const z=Math.sin(phi)*Math.sin(theta);

const plane=new THREE.Mesh(
new THREE.SphereGeometry(0.01,8,8),
new THREE.MeshBasicMaterial({color:0xffff00})
);

plane.position.set(x*1.02,y*1.02,z*1.02);

earth.add(plane);
planes.push(plane);

});

}

// обновление каждые 15 сек
setInterval(loadPlanes,15000);
loadPlanes();

// ===== ВРАЩЕНИЕ =====
function animate(){
requestAnimationFrame(animate);

earth.rotation.y+=0.0015;
clouds.rotation.y+=0.002;
night.rotation.y+=0.0015;

renderer.render(scene,camera);
}
animate();

// ===== RESIZE =====
window.addEventListener("resize",()=>{
camera.aspect=window.innerWidth/window.innerHeight;
camera.updateProjectionMatrix();
renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>

</body>
</html>
